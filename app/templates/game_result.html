{% extends 'base.html' %}

{% block title %}æ¸¸æˆç»“æœ{% endblock %}

{% block content %}
<div class="result-container">
    <div class="result-header {% if win %}result-win{% elif surrendered %}result-surrender{% else %}result-lose{% endif %}">
        {% if win %}
        <h1><i class="fas fa-trophy"></i> æ­å–œä½ çŒœå¯¹äº†ï¼</h1>
        {% elif surrendered %}
        <h1><i class="fas fa-flag"></i> ä½ å·²æŠ•é™</h1>
        {% else %}
        <h1><i class="fas fa-times-circle"></i> æ¸¸æˆç»“æŸ</h1>
        {% endif %}
    </div>
    
    <div class="answer-reveal">
        <h2>æ­£ç¡®ç­”æ¡ˆæ˜¯:</h2>
        <div class="servant-card">
            <div class="servant-name">{{ target_servant.name }}</div>
            <div class="servant-class">{{ target_servant.class_name }}</div>
            <div class="servant-details">
                <div class="detail-row">
                    <span class="detail-label">ç¨€æœ‰åº¦:</span>
                    <span class="detail-value">{% for i in range(target_servant.rarity) %}â˜…{% endfor %}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">æ€§åˆ«:</span>
                    <span class="detail-value">{{ target_servant.gender }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">é˜µè¥:</span>
                    <span class="detail-value">{{ target_servant.alignment }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">å±æ€§:</span>
                    <span class="detail-value">{{ target_servant.attribute }}</span>
                </div>
            </div>
            
            {% if target_servant.traits %}
            <div class="servant-traits">
                <span class="trait-label">ç‰¹æ€§:</span>
                {% for trait in target_servant.traits %}
                <span class="trait-tag">{{ trait }}</span>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- åœ¨ä»è€…ä¿¡æ¯å¡ä¸­æ·»åŠ ATKå’ŒHPæ˜¾ç¤º -->
            <div class="servant-stats">
                {% if 'atk_90' in session.compare_options %}
                <div class="stat-item">
                    <div class="stat-label">æ»¡çº§ATK</div>
                    <div class="stat-value">{{ target_servant.atk_90 }}</div>
                </div>
                {% endif %}
                
                {% if 'hp_90' in session.compare_options %}
                <div class="stat-item">
                    <div class="stat-label">æ»¡çº§HP</div>
                    <div class="stat-value">{{ target_servant.hp_90 }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="game-stats">
        <div class="stat-item">
            <div class="stat-value">{{ attempts }}/{{ max_attempts }}</div>
            <div class="stat-label">çŒœæµ‹æ¬¡æ•°</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ game_time }}</div>
            <div class="stat-label">ç”¨æ—¶</div>
        </div>
    </div>
    
    {% if guesses %}
    <div class="guess-history">
        <h3>çŒœæµ‹å†å²</h3>
        <div class="history-container">
            {% for i in range(guesses|length) %}
            <div class="history-item">
                <div class="guess-number">{{ i+1 }}</div>
                <div class="guess-name">{{ guesses[i].name }}</div>
                <div class="guess-comparison">
                    {% for attr, status in comparisons[i].items() %}
                    <div class="attr-compare {{ status }}">
                        <span class="attr-name">{{ attr }}</span>
                        {% if status == 'match' %}
                        <i class="fas fa-check"></i>
                        {% elif status == 'higher' %}
                        <i class="fas fa-arrow-up"></i>
                        {% elif status == 'lower' %}
                        <i class="fas fa-arrow-down"></i>
                        {% else %}
                        <i class="fas fa-times"></i>
                        {% endif %}
                    </div>
                    {% endfor %}
                    
                    <!-- åœ¨çŒœæµ‹å†å²è®°å½•æ˜¾ç¤ºä¸­åŒæ ·æ·»åŠ ATKå’ŒHPæ¯”è¾ƒ -->
                    {% if 'atk_90' in session.compare_options and 'æ»¡çº§ATK' in comparisons[i] %}
                    <div class="attr-compare {{ comparisons[i]['æ»¡çº§ATK'] }}">
                        <span class="attr-name">ATK</span>
                        <span class="attr-value">{{ guesses[i].atk_90 }}</span>
                        {% if comparisons[i]['æ»¡çº§ATK'] == 'match' %}
                        <i class="fas fa-check"></i>
                        {% elif comparisons[i]['æ»¡çº§ATK'] == 'higher' or comparisons[i]['æ»¡çº§ATK'] == 'close-higher' %}
                        <i class="fas fa-arrow-down hint higher"></i>
                        {% else %}
                        <i class="fas fa-arrow-up hint lower"></i>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if 'hp_90' in session.compare_options and 'æ»¡çº§HP' in comparisons[i] %}
                    <div class="attr-compare {{ comparisons[i]['æ»¡çº§HP'] }}">
                        <span class="attr-name">HP</span>
                        <span class="attr-value">{{ guesses[i].hp_90 }}</span>
                        {% if comparisons[i]['æ»¡çº§HP'] == 'match' %}
                        <i class="fas fa-check"></i>
                        {% elif comparisons[i]['æ»¡çº§HP'] == 'higher' or comparisons[i]['æ»¡çº§HP'] == 'close-higher' %}
                        <i class="fas fa-arrow-down hint higher"></i>
                        {% else %}
                        <i class="fas fa-arrow-up hint lower"></i>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <div class="action-buttons">
        <a href="{{ url_for('main.start_game') }}" class="btn btn-primary">
            <i class="fas fa-redo"></i> å†ç©ä¸€æ¬¡
        </a>
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
            <i class="fas fa-home"></i> è¿”å›é¦–é¡µ
        </a>
        
        <!-- æ·»åŠ åˆ†äº«ç»“æœæŒ‰é’® -->
        <button id="share-result" class="btn btn-success">
            <i class="fas fa-share-alt"></i> åˆ†äº«ç»“æœ
        </button>
    </div>
    
    <!-- æ·»åŠ ç»Ÿè®¡å±•ç¤º -->
    <div class="player-stats">
        <h3>ä½ çš„æ¸¸æˆç»Ÿè®¡</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ session.get('game_stats', {}).get('games', 0) }}</div>
                <div class="stat-title">æ€»æ¸¸æˆ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ session.get('game_stats', {}).get('wins', 0) }}</div>
                <div class="stat-title">è·èƒœ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ "%.1f"|format(session.get('game_stats', {}).get('avg_attempts', 0)) }}</div>
                <div class="stat-title">å¹³å‡çŒœæµ‹æ•°</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('share-result').addEventListener('click', function() {
    // æ„å»ºåˆ†äº«æ–‡æœ¬
    let resultEmoji = "{{ win }}" === "True" ? "ğŸ†" : ("{{ surrendered }}" === "True" ? "ğŸ³ï¸" : "âŒ");
    let shareText = `FGOä»è€…çŒœçŒœçœ‹ ${resultEmoji}\n`;
    shareText += `ç›®æ ‡ä»è€…: {{ target_servant.name }}\n`;
    shareText += `ç”¨æ—¶: {{ game_time }}\n`;
    shareText += `å°è¯•: {{ attempts }}/{{ max_attempts }}\n`;
    shareText += `#FGOä»è€…çŒœçŒœçœ‹`;
    
    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    navigator.clipboard.writeText(shareText).then(function() {
        alert('ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¯ä»¥åˆ†äº«ç»™å¥½å‹å•¦ï¼');
    }).catch(function(err) {
        console.error('æ— æ³•å¤åˆ¶: ', err);
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶åˆ†äº«');
    });
});
</script>
{% endblock %}